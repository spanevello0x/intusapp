<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intus Loop Simulator - DeFi Lending Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #00d4ff;
            --primary-dark: #0099cc;
            --secondary: #ffd700;
            --accent: #ff6b35;
            --dark: #0a0a1a;
            --darker: #151529;
            --card-bg: #1a1a2e;
            --card-darker: #16213e;
            --text-light: #ffffff;
            --text-cyan: #00d4ff;
            --text-gold: #ffd700;
            --text-muted: #a0a9c0;
            --success: #00ff88;
            --danger: #ff4757;
            --warning: #ffa502;
            --border: #2d3748;
            --shadow: 0 8px 32px rgba(0, 212, 255, 0.15);
            --shadow-lg: 0 20px 40px rgba(0, 212, 255, 0.25);
            --gradient-main: linear-gradient(135deg, #0a0a1a 0%, #1a1a2e 50%, #16213e 100%);
            --gradient-card: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            --gradient-primary: linear-gradient(45deg, #00d4ff, #0099cc);
            --gradient-gold: linear-gradient(45deg, #ffd700, #ffb700);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gradient-main);
            min-height: 100vh;
            color: var(--text-light);
            line-height: 1.6;
            position: relative;
            overflow-x: hidden;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 20% 80%, rgba(0, 212, 255, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(255, 215, 0, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        input, select, textarea {
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px;
            background: var(--gradient-card);
            border-radius: 25px;
            box-shadow: var(--shadow-lg);
            border: 2px solid rgba(0, 212, 255, 0.3);
        }

        .header h1 {
            font-size: 3.5rem;
            font-weight: 900;
            margin-bottom: 15px;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 2px;
        }

        .header p {
            font-size: 1.3rem;
            color: var(--text-muted);
            max-width: 800px;
            margin: 0 auto 25px;
            font-weight: 500;
        }

        .credits {
            font-size: 1rem;
            color: var(--text-muted);
            margin-top: 20px;
            padding: 20px;
            background: rgba(0, 212, 255, 0.05);
            border-radius: 15px;
        }

        .credits a {
            color: var(--text-cyan);
            text-decoration: none;
            font-weight: 600;
        }

        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .parameters-panel {
            background: var(--gradient-card);
            border-radius: 25px;
            padding: 30px;
            box-shadow: var(--shadow-lg);
            border: 3px solid rgba(0, 212, 255, 0.6);
            height: fit-content;
            position: sticky;
            top: 20px;
            animation: glow-pulse 3s ease-in-out infinite;
        }

        @keyframes glow-pulse {
            0%, 100% {
                border-color: rgba(0, 212, 255, 0.6);
                box-shadow: var(--shadow-lg), 0 0 30px rgba(0, 212, 255, 0.3);
            }
            50% {
                border-color: rgba(0, 212, 255, 0.9);
                box-shadow: var(--shadow-lg), 0 0 40px rgba(0, 212, 255, 0.5);
            }
        }

        .panel-title {
            font-size: 1.8rem;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 15px;
            text-align: center;
            border-bottom: 2px solid var(--border);
            padding-bottom: 15px;
        }

        .start-instruction {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.15), rgba(255, 215, 0, 0.15));
            border: 2px solid rgba(0, 212, 255, 0.4);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            text-align: center;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-light);
            line-height: 1.5;
            animation: instruction-pulse 2s ease-in-out infinite;
        }

        @keyframes instruction-pulse {
            0%, 100% {
                background: linear-gradient(135deg, rgba(0, 212, 255, 0.15), rgba(255, 215, 0, 0.15));
                transform: scale(1);
            }
            50% {
                background: linear-gradient(135deg, rgba(0, 212, 255, 0.25), rgba(255, 215, 0, 0.25));
                transform: scale(1.02);
            }
        }

        .start-instruction .emoji {
            font-size: 1.5rem;
            margin-bottom: 10px;
            display: block;
            animation: bounce 1.5s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        input, select {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid var(--border);
            border-radius: 15px;
            font-size: 16px;
            background: var(--card-darker);
            color: var(--text-light);
            transition: all 0.3s ease;
            font-weight: 500;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--text-cyan);
            box-shadow: 0 0 0 4px rgba(0, 212, 255, 0.15);
            background: var(--darker);
        }

        .btn {
            background: var(--gradient-primary);
            color: var(--dark);
            border: none;
            padding: 18px 35px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
            width: 100%;
            margin-top: 25px;
            text-transform: uppercase;
            letter-spacing: 1px;
            animation: button-glow 2s ease-in-out infinite;
        }

        @keyframes button-glow {
            0%, 100% {
                box-shadow: var(--shadow);
            }
            50% {
                box-shadow: var(--shadow), 0 0 20px rgba(0, 212, 255, 0.4);
            }
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg), 0 0 30px rgba(0, 212, 255, 0.6);
            animation: none;
        }

        .results-area {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .result-card {
            background: var(--gradient-card);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid var(--border);
            position: relative;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
        }

        .result-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .result-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .result-value {
            font-size: 2.2rem;
            font-weight: 900;
            color: var(--text-cyan);
            margin-bottom: 8px;
            line-height: 1.2;
        }

        .result-label {
            font-size: 1rem;
            color: var(--text-light);
            font-weight: 600;
            margin-bottom: 5px;
        }

        .result-description {
            font-size: 0.85rem;
            color: var(--text-muted);
            font-weight: 400;
            line-height: 1.4;
        }

        .result-message {
            font-size: 1rem;
            color: var(--text-muted);
            font-weight: 400;
            line-height: 1.5;
            text-align: center;
            padding: 10px;
        }

        .special-cards {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .health-factor-card {
            background: linear-gradient(135deg, var(--danger), #dc2626);
            border: 2px solid var(--danger);
            color: white;
            text-align: center;
            box-shadow: 0 8px 32px rgba(255, 71, 87, 0.3);
        }

        .health-factor-card .result-value {
            color: white;
            font-size: 3.5rem;
        }

        .loops-table {
            background: var(--gradient-card);
            border-radius: 25px;
            padding: 30px;
            border: 1px solid var(--border);
            overflow-x: auto;
            box-shadow: var(--shadow-lg);
        }

        .table-title {
            font-size: 1.6rem;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 25px;
            text-align: center;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th, td {
            padding: 12px 10px;
            text-align: right;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--card-darker);
            color: var(--text-cyan);
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tbody tr:hover {
            background: rgba(0, 212, 255, 0.08);
        }

        .positive {
            color: var(--success);
        }

        .negative {
            color: var(--danger);
        }

        .disclaimer-box {
            background: var(--gradient-card);
            border: 2px solid var(--text-gold);
            border-radius: 20px;
            padding: 30px;
            margin: 30px 0;
            border-left: 6px solid var(--text-gold);
            box-shadow: 0 8px 32px rgba(255, 215, 0, 0.15);
        }

        .disclaimer-box h3 {
            color: var(--text-gold);
            font-size: 1.4rem;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .footer {
            text-align: center;
            margin-top: 60px;
            padding: 50px;
            background: var(--gradient-card);
            border-radius: 25px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
        }

        .footer h3 {
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 25px;
            font-size: 2rem;
            font-weight: 800;
        }

        .social-links {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin: 40px 0;
            flex-wrap: wrap;
        }

        .social-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .social-group h4 {
            background: var(--gradient-gold);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 1.2rem;
            font-weight: 700;
        }

        .social-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            background: var(--card-darker);
            border-radius: 30px;
            border: 2px solid var(--border);
            transition: all 0.3s ease;
            text-decoration: none;
            color: var(--text-light);
            font-weight: 600;
        }

        .social-item:hover {
            background: var(--text-cyan);
            color: var(--dark);
            transform: translateY(-3px);
        }

        .pair-description {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 8px;
            padding: 12px;
            background: var(--card-darker);
            border-radius: 10px;
            border-left: 4px solid var(--text-cyan);
        }

        .educational-notice {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(0, 212, 255, 0.1));
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1rem;
            line-height: 1.5;
            color: var(--text-light);
        }

        .notice-icon {
            font-size: 2rem;
            flex-shrink: 0;
        }

        .notice-content {
            flex: 1;
        }

        .notice-content strong {
            color: var(--text-gold);
        }

        .hidden {
            display: none;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .parameters-panel {
                position: static;
                animation: none; /* Remove animation on mobile for better performance */
            }
            .results-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .special-cards {
                grid-template-columns: 1fr;
            }
            .start-instruction {
                animation: none; /* Remove animation on smaller screens */
            }
            .start-instruction .emoji {
                animation: none;
            }
            .btn {
                animation: none;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2.5rem;
            }
            .results-grid {
                grid-template-columns: 1fr;
            }
            .social-links {
                flex-direction: column;
            }
            .result-value {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 INTUS LOOP SIMULATOR</h1>
            <p>Calculadora completa para estratégias de Loop Lending em protocolos DeFi</p>
            <div class="credits">
                <strong>Founder:</strong> <a href="https://x.com/diego_intus" target="_blank">@diego_intus</a> | 
                <strong>Developer:</strong> <a href="https://x.com/mrdornellesf" target="_blank">@mrdornellesf</a><br>
                <strong>Feedback:</strong> intuswork@proton.me | 
                <strong>Instagram:</strong> <a href="https://www.instagram.com/intuscripto/" target="_blank">@intuscripto</a>
            </div>
        </div>

        <div class="disclaimer-box">
            <h3>📋 DISCLAIMER - IMPORTANTE</h3>
            <p><span style="color:var(--text-gold);font-weight:700">Esta calculadora fornece ESTIMATIVAS APROXIMADAS</span> para fins educacionais.</p>
            <p><strong>NÃO SOMOS RESPONSÁVEIS</strong> por perdas financeiras resultantes de falta de análise, conhecimento ou gestão de risco inadequada.</p>
            <p><span style="color:var(--text-gold);font-weight:700">SEMPRE:</span> Faça sua própria pesquisa (DYOR), consulte documentações oficiais e teste com valores pequenos.</p>
        </div>

        <div class="main-content">
            <div class="parameters-panel">
                <h2 class="panel-title">📊 Parâmetros de Entrada</h2>
                
                <div class="start-instruction">
                    <strong>COMECE AQUI!</strong><br>
                    Preencha todos os campos abaixo para calcular sua estratégia de Loop Lending.
                    <span class="emoji">👇</span>
                    <small style="color: var(--text-muted); margin-top: 10px; display: block;">
                        Os resultados aparecerão automaticamente após o cálculo
                    </small>
                </div>
                
                <div class="form-group">
                    <label>💰 Valor do Aporte USD</label>
                    <input type="number" id="aporteValue" placeholder="Ex: 5000" step="0.01">
                </div>
                
                <div class="form-group">
                    <label>📈 maxLTV (%)</label>
                    <input type="number" id="maxLTV" placeholder="Ex: 80" step="0.01" max="100">
                </div>
                
                <div class="form-group">
                    <label>⚠️ LLTV (%)</label>
                    <input type="number" id="LLTV" placeholder="Ex: 83" step="0.01" max="100">
                </div>
                
                <div class="form-group">
                    <label>💹 APR da Garantia (%)</label>
                    <input type="number" id="aprGarantia" placeholder="Ex: 2" step="0.01">
                </div>
                
                <div class="form-group">
                    <label>🔺 Juros da Dívida (%)</label>
                    <input type="number" id="jurosDivida" placeholder="Ex: 5" step="0.01">
                </div>
                
                <div class="form-group">
                    <label>🔄 Aplicar Juros?</label>
                    <select id="aplicarJuros">
                        <option value="">Selecione...</option>
                        <option value="sim">Sim</option>
                        <option value="nao">Não</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>⏰ Dias Exposição</label>
                    <input type="number" id="diasExposicao" placeholder="Ex: 90" min="1">
                </div>
                
                <div class="form-group">
                    <label>🔗 Tipo de Par</label>
                    <select id="tipoPar" onchange="_upd()">
                        <option value="">Selecione...</option>
                        <option value="descorrelacionado">Descorrelacionado</option>
                        <option value="correlacionado">Correlacionado</option>
                    </select>
                    <div id="pair-description" class="pair-description">
                        Selecione o tipo de par para ver a descrição do risco.
                    </div>
                </div>
                
                <div class="form-group">
                    <label>🪙 Preço do Token Garantia (USD)</label>
                    <input type="number" id="precoTokenGarantia" placeholder="Ex: 2500" step="0.0001">
                </div>
                
                <div class="form-group">
                    <label>💎 Preço do Token Dívida (USD)</label>
                    <input type="number" id="precoTokenDivida" placeholder="Ex: 1" step="0.0001">
                </div>
                
                <div class="form-group">
                    <label>💸 Valor Mínimo Loop (USD)</label>
                    <input type="number" id="valorMinimoLoop" placeholder="Ex: 1000" step="0.01">
                </div>
                
                <button class="btn" onclick="_calc()">🧮 CALCULAR SIMULAÇÃO</button>
            </div>

            <div class="results-area">
                <div id="educational-notice" class="educational-notice">
                    <div class="notice-icon">💡</div>
                    <div class="notice-content">
                        <strong>Dica:</strong> <span id="educational-message"></span>
                    </div>
                </div>

                <div class="results-grid">
                    <div class="result-card">
                        <div class="result-value" id="eff-loop-max" style="display: none;"></div>
                        <div class="result-label">Loop Máximo</div>
                        <div class="result-description" id="desc-loop-max">quantidade de loops considerando valor mínimo</div>
                    </div>
                    
                    <div class="result-card">
                        <div class="result-value" id="eff-apr-value" style="display: none;"></div>
                        <div class="result-label">Valor do APR USD</div>
                        <div class="result-description" id="desc-apr-value">valor do apr do colateral</div>
                    </div>
                    
                    <div class="result-card">
                        <div class="result-value" id="eff-leverage" style="display: none;"></div>
                        <div class="result-label">Alavancagem Máxima</div>
                        <div class="result-description" id="desc-leverage">alavancagem do capital inicial</div>
                    </div>
                    
                    <div class="result-card">
                        <div class="result-value" id="eff-interest-value" style="display: none;"></div>
                        <div class="result-label">Valor dos Juros USD</div>
                        <div class="result-description" id="desc-interest-value">valor dos juros da dívida</div>
                    </div>
                    
                    <div class="result-card">
                        <div class="result-value" id="eff-collateral-final" style="display: none;"></div>
                        <div class="result-label">Colateral Final</div>
                        <div class="result-description" id="desc-collateral-final">valor total de colateral</div>
                    </div>
                    
                    <div class="result-card">
                        <div class="result-value" id="eff-profit-loss" style="display: none;"></div>
                        <div class="result-label">Lucro/Prejuízo USD</div>
                        <div class="result-description" id="desc-profit-loss">valor final da operação</div>
                    </div>
                    
                    <div class="result-card">
                        <div class="result-value" id="eff-debt-final" style="display: none;"></div>
                        <div class="result-label">Dívida Final</div>
                        <div class="result-description" id="desc-debt-final">valor total da dívida</div>
                    </div>
                    
                    <div class="result-card">
                        <div class="result-value" id="eff-roi" style="display: none;"></div>
                        <div class="result-label">ROI (%)</div>
                        <div class="result-description" id="desc-roi">retorno considerando APR da garantia e custos dos juros da dívida</div>
                    </div>
                </div>

                <div class="special-cards">
                    <div class="result-card health-factor-card">
                        <div class="result-value" id="health-factor" style="display: none;"></div>
                        <div class="result-label">Fator de Saúde Final</div>
                        <div class="result-description" id="desc-health-factor">fator de saúde no último loop - quanto menor, maior o risco de liquidação</div>
                    </div>
                    
                    <div class="result-card">
                        <div class="result-value" id="liquidation-price" style="display: none;"></div>
                        <div class="result-label" id="liquidation-label">Preço de Liquidação</div>
                        <div class="result-description" id="liquidation-desc">preço que aciona liquidação automaticamente</div>
                    </div>
                    
                    <div class="result-card">
                        <div class="result-value" id="liquidation-percent" style="display: none;"></div>
                        <div class="result-label" id="percent-label">% de Liquidação</div>
                        <div class="result-description" id="percent-desc">percentual de queda necessário no ativo para ativar a liquidação</div>
                    </div>
                </div>

                <div class="loops-table">
                    <h3 class="table-title">📋 Detalhamento dos Loops</h3>
                    <div style="max-height:500px;overflow-y:auto">
                        <table>
                            <thead>
                                <tr>
                                    <th>Loop</th>
                                    <th>Colateral (tk)</th>
                                    <th>Dívida (tk)</th>
                                    <th>Colateral USD</th>
                                    <th>Dívida USD</th>
                                    <th>LTV</th>
                                    <th>Alavancagem</th>
                                    <th>Margem LLTV</th>
                                    <th>Health Factor</th>
                                    <th>Preço Liquidação</th>
                                    <th>Capacidade Restante</th>
                                </tr>
                            </thead>
                            <tbody id="loops-tbody">
                                <tr>
                                    <td colspan="11" style="text-align: center; padding: 40px; color: var(--text-muted);">
                                        Calculando seu Looping de Empréstimo você pode economizar tempo montando uma operação só com valor maior! Veja na tabela de loops após efetuar os calculos.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <h3>🌟 Intus Loop Simulator</h3>
            <p>Ferramenta educacional para simulação de estratégias Loop Lending em DeFi.</p>
            
            <div class="social-links">
                <div class="social-group">
                    <h4>👨‍💼 Founder - Diego Intus</h4>
                    <a href="https://x.com/diego_intus" target="_blank" class="social-item">
                        <span>🐦</span> @diego_intus
                    </a>
                    <a href="https://www.instagram.com/intuscripto/" target="_blank" class="social-item">
                        <span>📸</span> @intuscripto
                    </a>
                    <a href="https://www.youtube.com/@IntusCripto" target="_blank" class="social-item">
                        <span>🎥</span> IntusCripto
                    </a>
                </div>
                
                <div class="social-group">
                    <h4>👨‍💻 Developer</h4>
                    <a href="https://x.com/mrdornellesf" target="_blank" class="social-item">
                        <span>🐦</span> @mrdornellesf
                    </a>
                </div>
                
                <div class="social-group">
                    <h4>📧 Contato</h4>
                    <a href="mailto:intuswork@proton.me" class="social-item">
                        <span>📧</span> intuswork@proton.me
                    </a>
                </div>
            </div>
            
            <div style="margin-top:40px;padding-top:30px;border-top:2px solid var(--border);color:var(--text-muted)">
                <p>© 2025 <span style="color:var(--text-cyan);font-weight:700">Intus Cripto</span>. Desenvolvido com ❤️ para a comunidade DeFi.</p>
                <p style="margin:10px 0 0 0;font-size:0.9rem">Estimativas aproximadas • Use por sua conta e risco • DYOR sempre</p>
            </div>
        </div>
    </div>

    <script>
        let _data = [];
        let isCalculated = false;

        // Mensagens educativas para exibir nos cards
        const educationalMessages = [
            "Calculando seu Looping de Empréstimo você pode economizar tempo montando uma operação só com valor maior! Veja na tabela de loops após efetuar os calculos.",
            "Calcule se sua arbitragem de Yield será Positiva ou Negativa! Vale a pena o risco desses tokens e desse protocolo, pelo Yield que você busca?",
            "Se você Estiver farmando airdrop com looping, entenda que seu custo é o 'Borrow' (Juros) a ser pago. Porém, você precisa calcular os pontos a serem conquistados e analisar viabilidade da operação.",
            "O Loop Lending permite aumentar sua exposição a um ativo usando-o como colateral para pegar mais dele emprestado. Calcule os riscos!",
            "Atenção aos Health Factors baixos! Quanto menor o HF, maior o risco de liquidação da sua posição.",
            "Diferentes protocolos têm diferentes taxas de juros. Compare sempre antes de executar sua estratégia!",
            "O looping funciona melhor em mercados de alta, mas pode acelerar perdas em mercados de baixa. Calcule cenários!",
            "Tokens de yield (como stETH, sUSDe) podem ter depeg temporário. Considere esse risco na sua estratégia."
        ];

        function getRandomMessage() {
            return educationalMessages[Math.floor(Math.random() * educationalMessages.length)];
        }

        function showEducationalNotice() {
            // Mostra mensagem educativa aleatória apenas no carregamento inicial
            const messageElement = document.getElementById('educational-message');
            if (messageElement) {
                messageElement.textContent = getRandomMessage();
            }
        }

        function hideEducationalNotice() {
            const notice = document.getElementById('educational-notice');
            if (notice) {
                notice.style.display = 'none';
            }
        }

        function _upd() {
            const tipoPar = document.getElementById('tipoPar').value;
            const description = document.getElementById('pair-description');
            
            if (tipoPar === 'correlacionado') {
                description.innerHTML = '🔄 <strong style="color:var(--text-cyan)">Arbitragem de Yields:</strong> Stablecoins com rendimento vs normais (ex: sUSDE/USDC). <strong style="color:var(--text-gold)">Risco:</strong> Depeg da stablecoin com yield.';
            } else if (tipoPar === 'descorrelacionado') {
                description.innerHTML = '📈 <strong style="color:var(--text-cyan)">Volatilidade:</strong> Ativos voláteis vs stablecoins (ex: ETH/USDC). <strong style="color:var(--text-gold)">Risco:</strong> mudança de preços relativos.';
            } else {
                description.innerHTML = 'Selecione o tipo de par para ver a descrição do risco.';
            }
        }

        function clearResults() {
            // Oculta os valores 
            document.getElementById('eff-loop-max').style.display = 'none';
            document.getElementById('eff-apr-value').style.display = 'none';
            document.getElementById('eff-leverage').style.display = 'none';
            document.getElementById('eff-interest-value').style.display = 'none';
            document.getElementById('eff-collateral-final').style.display = 'none';
            document.getElementById('eff-profit-loss').style.display = 'none';
            document.getElementById('eff-debt-final').style.display = 'none';
            document.getElementById('eff-roi').style.display = 'none';
            document.getElementById('health-factor').style.display = 'none';
            document.getElementById('liquidation-price').style.display = 'none';
            document.getElementById('liquidation-percent').style.display = 'none';

            // Remove classes de cor
            document.getElementById('eff-profit-loss').className = 'result-value';
            document.getElementById('eff-roi').className = 'result-value';

            // Limpa a tabela
            const tbody = document.getElementById('loops-tbody');
            tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 40px; color: var(--text-muted);">Preencha os parâmetros de entrada e clique em calcular para ver o detalhamento de cada loop da sua estratégia. Aqui você verá informações detalhadas sobre colateral, dívida, alavancagem e riscos de cada etapa.</td></tr>';

            isCalculated = false;
        }

        function _calc() {
            // Oculta a mensagem educativa quando calcular pela primeira vez
            hideEducationalNotice();

            const aporteValue = parseFloat(document.getElementById('aporteValue').value) || 0;
            const maxLTV = parseFloat(document.getElementById('maxLTV').value) || 0;
            const LLTV = parseFloat(document.getElementById('LLTV').value) || 0;
            const aprGarantia = parseFloat(document.getElementById('aprGarantia').value) || 0;
            const jurosDivida = parseFloat(document.getElementById('jurosDivida').value) || 0;
            const aplicarJuros = document.getElementById('aplicarJuros').value === 'sim';
            const diasExposicao = parseFloat(document.getElementById('diasExposicao').value) || 0;
            const precoTokenGarantia = parseFloat(document.getElementById('precoTokenGarantia').value) || 0;
            const precoTokenDivida = parseFloat(document.getElementById('precoTokenDivida').value) || 0;
            const valorMinimoLoop = parseFloat(document.getElementById('valorMinimoLoop').value) || 0;

            // Validação básica
            if (!aporteValue || !maxLTV || !LLTV || !precoTokenGarantia || !precoTokenDivida) {
                alert('Por favor, preencha todos os campos obrigatórios!');
                return;
            }

            _data = [];
            let colateralTokens = aporteValue / precoTokenGarantia;
            let dividaTokens = 0;
            let loop = 0;

            while (true) {
                loop++;
                const colateralUSD = colateralTokens * precoTokenGarantia;
                const dividaUSD = dividaTokens * precoTokenDivida;
                const ltv = dividaUSD / colateralUSD;
                const alavancagem = colateralUSD / aporteValue;
                const healthFactor = dividaUSD > 0 ? (colateralUSD * (LLTV / 100)) / dividaUSD : Infinity;
                const liquidationPrice = dividaUSD / (colateralTokens * (LLTV / 100));
                const capacidadeEmprestimo = colateralUSD * (maxLTV / 100);
                const capacidadeRestante = capacidadeEmprestimo - dividaUSD;

                _data.push({
                    loop: loop,
                    colateralTokens: colateralTokens,
                    dividaTokens: dividaTokens,
                    colateralUSD: colateralUSD,
                    dividaUSD: dividaUSD,
                    ltv: ltv * 100,
                    alavancagem: alavancagem,
                    margemLLTV: ((LLTV - ltv * 100) / LLTV) * 100,
                    healthFactor: healthFactor,
                    liquidationPrice: liquidationPrice,
                    capacidadeRestante: capacidadeRestante
                });

                if (capacidadeRestante < valorMinimoLoop || ((LLTV - ltv * 100) / LLTV) * 100 <= 3.61) {
                    break;
                }

                const novoEmprestimo = capacidadeEmprestimo - dividaUSD;
                const novosTokensColateral = novoEmprestimo / precoTokenGarantia;
                colateralTokens += novosTokensColateral;
                dividaTokens = capacidadeEmprestimo / precoTokenDivida;
            }

            _res(aporteValue, aprGarantia, jurosDivida, aplicarJuros, diasExposicao, valorMinimoLoop);
            _tbl();
            isCalculated = true;
        }

        function _res(aporteValue, aprGarantia, jurosDivida, aplicarJuros, diasExposicao, valorMinimoLoop) {
            const tipoPar = document.getElementById('tipoPar').value;
            
            let loopsValidos = [];
            for (let i = 0; i < _data.length; i++) {
                loopsValidos.push(_data[i]);
                if (_data[i].capacidadeRestante < valorMinimoLoop) {
                    break;
                }
            }

            const ultimoLoop = loopsValidos[loopsValidos.length - 1];
            const colateralFinal = ultimoLoop.colateralUSD;
            const dividaFinal = ultimoLoop.dividaUSD;
            const alavancagem = ultimoLoop.alavancagem;
            const healthFactor = ultimoLoop.healthFactor;
            const liquidationPrice = ultimoLoop.liquidationPrice;

            const aprValue = colateralFinal * (aprGarantia / 100) * (diasExposicao / 365);
            const interestValue = aplicarJuros ? dividaFinal * (jurosDivida / 100) * (diasExposicao / 365) : 0;
            const profitLoss = aprValue - interestValue;
            const roi = (profitLoss / aporteValue) * 100;
            const LLTV = parseFloat(document.getElementById('LLTV').value);
            const margemLiquidacao = (1 - dividaFinal / (colateralFinal * (LLTV / 100))) * 100;

            // Update DOM elements and show values
            document.getElementById('eff-loop-max').textContent = loopsValidos.length;
            document.getElementById('eff-loop-max').style.display = 'block';
            
            document.getElementById('eff-leverage').textContent = alavancagem.toFixed(2) + 'x';
            document.getElementById('eff-leverage').style.display = 'block';
            
            document.getElementById('eff-collateral-final').textContent = _fmt(colateralFinal);
            document.getElementById('eff-collateral-final').style.display = 'block';
            
            document.getElementById('eff-debt-final').textContent = _fmt(dividaFinal);
            document.getElementById('eff-debt-final').style.display = 'block';
            
            document.getElementById('eff-apr-value').textContent = _fmt(aprValue);
            document.getElementById('eff-apr-value').style.display = 'block';
            
            document.getElementById('eff-interest-value').textContent = _fmt(interestValue);
            document.getElementById('eff-interest-value').style.display = 'block';
            
            document.getElementById('eff-profit-loss').textContent = _fmt(profitLoss);
            document.getElementById('eff-profit-loss').style.display = 'block';
            
            document.getElementById('eff-roi').textContent = roi.toFixed(2) + '%';
            document.getElementById('eff-roi').style.display = 'block';
            
            document.getElementById('health-factor').textContent = healthFactor.toFixed(2);
            document.getElementById('health-factor').style.display = 'block';

            if (tipoPar === 'correlacionado') {
                document.getElementById('liquidation-label').textContent = '% de Depeg';
                document.getElementById('liquidation-desc').textContent = 'depeg % necessário para liquidação';
                document.getElementById('liquidation-price').textContent = margemLiquidacao.toFixed(2) + '%';
                document.getElementById('liquidation-price').style.display = 'block';
                document.getElementById('percent-label').textContent = 'Valor de Referência';
                document.getElementById('percent-desc').textContent = 'valor atual do token colateral';
                document.getElementById('liquidation-percent').textContent = _fmt(parseFloat(document.getElementById('precoTokenGarantia').value));
                document.getElementById('liquidation-percent').style.display = 'block';
            } else {
                document.getElementById('liquidation-label').textContent = 'Preço de Liquidação';
                document.getElementById('liquidation-desc').textContent = 'preço que aciona liquidação automaticamente';
                document.getElementById('liquidation-price').textContent = _fmt(liquidationPrice);
                document.getElementById('liquidation-price').style.display = 'block';
                document.getElementById('percent-label').textContent = '% de Liquidação';
                document.getElementById('percent-desc').textContent = 'percentual de queda necessário no ativo para ativar a liquidação';
                document.getElementById('liquidation-percent').textContent = margemLiquidacao.toFixed(2) + '%';
                document.getElementById('liquidation-percent').style.display = 'block';
            }

            // Color coding for profit/loss
            const profitElement = document.getElementById('eff-profit-loss');
            const profitValue = parseFloat(profitElement.textContent.replace(/[^-0-9.]/g, ''));
            profitElement.className = profitValue >= 0 ? 'result-value positive' : 'result-value negative';

            const roiElement = document.getElementById('eff-roi');
            const roiValue = parseFloat(roiElement.textContent.replace('%', ''));
            roiElement.className = roiValue >= 0 ? 'result-value positive' : 'result-value negative';
        }

        function _tbl() {
            const tbody = document.getElementById('loops-tbody');
            tbody.innerHTML = '';
            
            _data.forEach((loop, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${loop.loop}</td>
                    <td>${loop.colateralTokens.toFixed(2)}</td>
                    <td>${loop.dividaTokens.toFixed(2)}</td>
                    <td>${_fmt(loop.colateralUSD)}</td>
                    <td>${_fmt(loop.dividaUSD)}</td>
                    <td>${loop.ltv.toFixed(2)}%</td>
                    <td>${loop.alavancagem.toFixed(2)}x</td>
                    <td>${loop.margemLLTV.toFixed(2)}%</td>
                    <td>${loop.healthFactor.toFixed(2)}</td>
                    <td>${_fmt(loop.liquidationPrice)}</td>
                    <td>${_fmt(loop.capacidadeRestante)}</td>
                `;
                
                if (loop.healthFactor < 1.1) {
                    row.style.backgroundColor = 'rgba(255, 71, 87, 0.1)';
                }
            });
        }

        function _fmt(value) {
            if (value < 0) {
                return '-$' + Math.abs(value).toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            }
            return '$' + value.toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Mostra mensagem educativa aleatória inicial
            showEducationalNotice();
            
            // Adiciona event listeners para limpar resultados quando inputs mudarem
            const inputs = document.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.addEventListener('input', function() {
                    if (isCalculated) {
                        clearResults();
                    }
                });
                input.addEventListener('change', function() {
                    if (isCalculated) {
                        clearResults();
                    }
                });
                input.addEventListener('keyup', function() {
                    if (isCalculated) {
                        clearResults();
                    }
                });
            });

            // Proteções aplicadas após o carregamento
            setTimeout(() => {
                // Prevenir clique direito
                document.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    return false;
                });

                // Prevenir F12 e outras teclas de desenvolvedor
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'F12' || 
                        (e.ctrlKey && e.key === 'u') || 
                        (e.ctrlKey && e.shiftKey && e.key === 'I') || 
                        (e.ctrlKey && e.shiftKey && e.key === 'J') || 
                        (e.ctrlKey && e.shiftKey && e.key === 'C')) {
                        e.preventDefault();
                        return false;
                    }
                });
            }, 1000);
        });
    </script>
</body>
</html>